<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile | Ipakodo ’98 Set</title>

  <!-- Favicon -->
  <link rel="icon" href="/assets/images/logo/New site logo.png" type="image/x-icon">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

<!-- Components -->
  <link rel="stylesheet" href="/assets/css/page.css">
  <link rel="stylesheet" href="/assets/css/theme.css">
  <link rel="stylesheet" href="/assets/css/animations.css">
  <link rel="stylesheet" href="/components/navbar.css">
  <link rel="stylesheet" href="/components/footer.css">
</head>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            primary: '#1e40af',
            'primary-light': '#60a5fa',
            accent: '#10b981',
            muted: '#6b7280',
            soft: '#f8fafc',
            glass: 'rgba(255, 255, 255, 0.85)',
            danger: '#ef4444'
          },
          boxShadow: {
            card: '0 10px 25px -5px rgba(0, 0, 0, 0.08)',
            'card-hover': '0 20px 40px -10px rgba(0, 0, 0, 0.12)'
          }
        }
      }
    }
  </script>

  <style>
    .hero-bg {
      background: url('/assets/images/background/blue\ background.png') center/cover no-repeat;
    }
    .glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .tab-active {
      @apply border-b-4 border-primary text-primary font-semibold;
    }
  </style>
</head>

<body class="bg-soft min-h-screen">
  <!-- NAVBAR -->
  <div id="navbar"></div>

  <!-- Hero Section -->
  <section class="hero-bg text-white py-12 md:py-20 lg:py-28 relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-b from-black/5 via-transparent to-black/15"></div>

    <div class="max-w-5xl mx-auto px-6 relative z-10">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 lg:gap-24 items-center text-center md:text-left">
        <!-- Profile Photo -->
        <div class="order-1 md:order-none">
          <div class="relative inline-block group">
            <img id="profile-photo" 
                 src="/assets/images/logo/logo1.png"
                 alt="Profile"
                 class="w-32 h-32 md:w-48 md:h-48 rounded-full object-cover border-4 border-white/70 shadow-md transition-transform duration-500 group-hover:scale-105">
            
            <span id="verified-badge" class="absolute -bottom-1 left-1/2 -translate-x-1/2 md:left-auto md:right-1 md:bottom-1 md:translate-x-0 bg-accent text-white px-2.5 py-1 rounded-full text-xs font-medium shadow-sm hidden flex items-center gap-1 border border-white/10">
              <i class="fas fa-check-circle text-xs"></i> Verified
            </span>
          </div>
        </div>

        <!-- Info & Buttons -->
        <div class="md:col-span-2 space-y-6 order-2">
          <div class="space-y-2">
            <h1 id="member-name" class="text-4xl md:text-4xl lg:text-5xl font-semibold tracking-wider text-white">
              Loading...
            </h1>
            <p id="member-position" class="text-base md:text-lg font-light text-white">—</p>

            <div class="flex flex-wrap justify-center md:justify-start gap-3 text-sm">
              <span id="location-badge" class="flex items-center gap-1.5 bg-white/8 backdrop-blur-md px-3.5 py-1.5 rounded-full border border-white/5 hover:bg-white/15 transition text-white">
                <i class="fas fa-map-marker-alt text-sm"></i> —
              </span>
              <span id="member-id" class="bg-white/10 backdrop-blur-md px-4 py-2 rounded-full border border-white/5 text-white">
                Member ID: —
              </span>
            </div>

            <!-- Social Icons -->
            <div class="flex justify-center md:justify-start gap-4 text-xl md:text-2xl mt-5">
              <a id="email-link" href="#" class="bg-white/5 p-2 rounded-full backdrop-blur-sm hover:bg-accent/60 hover:scale-110 transition-all duration-300 hidden text-white"><i class="fas fa-envelope"></i></a>
              <a id="phone-link" href="#" class="bg-white/5 p-2 rounded-full backdrop-blur-sm hover:bg-accent/60 hover:scale-110 transition-all duration-300 hidden text-white"><i class="fas fa-phone"></i></a>
              <a id="whatsapp-link" href="#" target="_blank" class="bg-white/5 p-2 rounded-full backdrop-blur-sm hover:bg-accent/60 hover:scale-110 transition-all duration-300 hidden text-white"><i class="fab fa-whatsapp"></i></a>
              <a id="linkedin-link" href="#" target="_blank" class="bg-white/5 p-2 rounded-full backdrop-blur-sm hover:bg-accent/60 hover:scale-110 transition-all duration-300 hidden text-white"><i class="fab fa-linkedin-in"></i></a>
              <a id="twitter-link" href="#" target="_blank" class="bg-white/5 p-2 rounded-full backdrop-blur-sm hover:bg-accent/60 hover:scale-110 transition-all duration-300 hidden text-white"><i class="fab fa-twitter"></i></a>
              <a id="facebook-link" href="#" target="_blank" class="bg-white/5 p-2 rounded-full backdrop-blur-sm hover:bg-accent/60 hover:scale-110 transition-all duration-300 hidden text-white"><i class="fab fa-facebook-f"></i></a>
              <a id="instagram-link" href="#" target="_blank" class="bg-white/5 p-2 rounded-full backdrop-blur-sm hover:bg-accent/60 hover:scale-110 transition-all duration-300 hidden text-white"><i class="fab fa-instagram"></i></a>
              <a id="github-link" href="#" target="_blank" class="bg-white/5 p-2 rounded-full backdrop-blur-sm hover:bg-accent/60 hover:scale-110 transition-all duration-300 hidden text-white"><i class="fab fa-github"></i></a>
              <a id="website-link" href="#" target="_blank" class="bg-white/5 p-2 rounded-full backdrop-blur-sm hover:bg-accent/60 hover:scale-110 transition-all duration-300 hidden text-white"><i class="fas fa-globe"></i></a>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-wrap justify-center md:justify-start gap-4 mt-6">
            <button id="edit-profile" class="px-5 py-2.5 bg-accent text-white rounded-full font-medium text-sm shadow-sm hover:shadow-md hover:bg-accent/90 hover:-translate-y-0.5 transition-all duration-300 flex items-center gap-2">
              <i class="fas fa-edit text-base"></i> Edit Profile
            </button>

            <a id="dashboard-btn" href="/pages/dashboard/admin-dashboard.html" class="hidden px-6 py-2.5 bg-primary text-white rounded-full font-medium shadow-md hover:bg-primary/90 hover:shadow-lg transition-all duration-300 flex items-center gap-2">
              <i class="fas fa-tachometer-alt text-base"></i> My Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="absolute bottom-0 left-0 right-0">
      <svg viewBox="0 0 1440 80" preserveAspectRatio="none" class="w-full h-12 md:h-16 lg:h-20 text-soft opacity-60">
        <path fill="currentColor" d="M0,0 C480,50 960,20 1440,50 L1440,80 L0,80 Z"></path>
      </svg>
    </div>
  </section>

  <!-- Content Tabs Section -->
  <section class="py-12 md:py-16 lg:py-20 bg-soft">
    <div class="max-w-6xl mx-auto px-6">
      <div class="flex justify-center gap-12 mb-16 border-b border-gray-200">
        <button data-tab="overview" class="pb-4 px-4 text-lg font-medium tab-active">Overview</button>
        <button data-tab="dues" class="pb-4 px-4 text-lg font-medium text-muted hover:text-primary transition">Dues History</button>
        <button data-tab="donations" class="pb-4 px-4 text-lg font-medium text-muted hover:text-primary transition">Donations</button>
      </div>

      <!-- Overview Tab -->
      <div id="tab-overview">
        <div class="grid lg:grid-cols-3 gap-12 lg:gap-16">
          <div class="space-y-12">
            <div class="glass rounded-3xl p-10 shadow-card hover:shadow-card-hover transition-shadow">
              <h3 class="text-2xl font-semibold mb-8 text-primary flex items-center gap-4">
                <i class="fas fa-graduation-cap text-3xl"></i> Education
              </h3>
              <div id="education-display" class="text-gray-700 leading-relaxed text-base">
                <p class="text-center text-muted">Loading...</p>
              </div>
            </div>

            <div class="glass rounded-3xl p-10 shadow-card hover:shadow-card-hover transition-shadow">
              <h3 class="text-2xl font-semibold mb-8 text-primary flex items-center gap-4">
                <i class="fas fa-heart text-3xl"></i> Interests
              </h3>
              <div id="interests-display" class="flex flex-wrap gap-4">
                <p class="text-muted">Loading...</p>
              </div>
            </div>
          </div>

          <div class="lg:col-span-2">
            <div class="glass rounded-3xl p-12 shadow-card hover:shadow-card-hover transition-shadow">
              <h3 class="text-2xl font-semibold mb-8 text-primary">About Me</h3>
              <p id="bio-text" class="text-lg leading-loose text-gray-700">Loading...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Dues History Tab -->
      <div id="tab-dues" class="hidden">
        <div class="glass rounded-3xl p-10 shadow-card">
          <div class="flex justify-between items-center mb-10">
            <h3 class="text-2xl font-semibold text-primary flex items-center gap-4">
              <i class="fas fa-money-bill-wave text-3xl"></i> Dues History
            </h3>
            <a href="/pages/pay-dues.html" class="px-6 py-3 bg-primary text-white rounded-xl font-medium shadow-md hover:bg-primary/90 hover:shadow-lg transition">
              Pay My Dues
            </a>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full min-w-[800px] text-left">
              <thead>
                <tr class="border-b-2 border-primary/20">
                  <th class="pb-6 text-sm font-semibold text-primary uppercase tracking-wider">Year</th>
                  <th class="pb-6 text-sm font-semibold text-primary uppercase tracking-wider">Amount</th>
                  <th class="pb-6 text-sm font-semibold text-primary uppercase tracking-wider">Category</th>
                  <th class="pb-6 text-sm font-semibold text-primary uppercase tracking-wider">Payment Date</th>
                  <th class="pb-6 text-sm font-semibold text-primary uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody id="dues-body" class="divide-y divide-gray-200">
                <tr><td colspan="5" class="text-center py-12 text-muted text-lg">Loading dues history...</td></tr>
              </tbody>
            </table>

            <div id="dues-pagination" class="mt-8 flex justify-center gap-2 hidden">
              <button id="dues-prev" class="px-4 py-2 bg-gray-200 rounded-lg disabled:opacity-50" disabled>Previous</button>
              <span id="dues-page-info" class="px-4 py-2 text-gray-700"></span>
              <button id="dues-next" class="px-4 py-2 bg-gray-200 rounded-lg">Next</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Donations Tab -->
      <div id="tab-donations" class="hidden">
        <div class="glass rounded-3xl p-10 shadow-card">
          <div class="flex justify-between items-center mb-10">
            <h3 class="text-2xl font-semibold text-primary flex items-center gap-4">
              <i class="fas fa-hand-holding-heart text-3xl"></i> Donation History
            </h3>
            <a href="/pages/donate.html" class="px-6 py-3 bg-accent text-white rounded-xl font-medium shadow-md hover:bg-accent/90 hover:shadow-lg transition">
              Donate Now
            </a>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full min-w-[800px] text-left">
              <thead>
                <tr class="border-b-2 border-accent/20">
                  <th class="pb-6 text-sm font-semibold text-primary uppercase tracking-wider">Date</th>
                  <th class="pb-6 text-sm font-semibold text-primary uppercase tracking-wider">Description</th>
                  <th class="pb-6 text-sm font-semibold text-primary uppercase tracking-wider">Amount</th>
                  <th class="pb-6 text-sm font-semibold text-primary uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody id="donations-body" class="divide-y divide-gray-200">
                <tr><td colspan="4" class="text-center py-12 text-muted text-lg">Loading donation history...</td></tr>
              </tbody>
            </table>

            <div id="donations-pagination" class="mt-8 flex justify-center gap-2 hidden">
              <button id="donations-prev" class="px-4 py-2 bg-gray-200 rounded-lg disabled:opacity-50" disabled>Previous</button>
              <span id="donations-page-info" class="px-4 py-2 text-gray-700"></span>
              <button id="donations-next" class="px-4 py-2 bg-gray-200 rounded-lg">Next</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Edit Profile Modal -->
  <div id="edit-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-3xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-primary">Edit Profile</h2>
          <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-3xl leading-none">&times;</button>
        </div>

        <form id="edit-form" class="space-y-6">
          <!-- Photo -->
          <div class="text-center">
            <img id="preview-photo" src="/assets/images/logo/logo1.png" alt="Preview" class="w-32 h-32 rounded-full object-cover border-4 border-primary/30 mx-auto mb-4">
            <label class="cursor-pointer">
              <span class="px-6 py-3 bg-primary text-white rounded-full font-medium hover:bg-primary/90 transition inline-block">Change Photo</span>
              <input type="file" id="photo-input" accept="image/*" class="hidden">
            </label>
          </div>

          <!-- Basic Info -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
              <input type="text" id="input-fullname" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nickname</label>
              <input type="text" id="input-nickname" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Position / Title</label>
              <input type="text" id="input-position" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
              <input type="tel" id="input-phone" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
              <input type="email" id="input-email" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
              <input type="text" id="input-location" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
          </div>

          <!-- Social Media -->
          <div class="border-t pt-6">
            <h3 class="text-lg font-semibold text-primary mb-4">Social Media & Website</h3>
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Twitter (X)</label>
                <input type="url" id="input-twitter" placeholder="https://twitter.com/username" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Facebook</label>
                <input type="url" id="input-facebook" placeholder="https://facebook.com/username" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Instagram</label>
                <input type="url" id="input-instagram" placeholder="https://instagram.com/username" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">GitHub</label>
                <input type="url" id="input-github" placeholder="https://github.com/username" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">LinkedIn</label>
                <input type="url" id="input-linkedin" placeholder="https://linkedin.com/in/username" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Personal Website</label>
                <input type="url" id="input-website" placeholder="https://yourwebsite.com" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
            <textarea id="input-bio" rows="5" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Education (one per line)</label>
            <textarea id="input-education" rows="5" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Interests (comma separated)</label>
            <input type="text" id="input-interests" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>

          <div class="flex justify-end gap-4 pt-6">
            <button type="button" id="cancel-edit" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300 transition">
              Cancel
            </button>
            <button type="submit" class="px-8 py-3 bg-primary text-white rounded-xl font-medium shadow-md hover:bg-primary/90 transition">
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Complete Script with Fixed Dues & Donations Loading + Realtime -->
  <script type="module">
    import { supabase } from '../../assets/js/supabase-client.js';

    const PAGE_SIZE = 10;
    let currentMember = null;
    let currentPhotoFile = null;

    let duesData = [];
    let duesCurrentPage = 1;
    let duesSubscription = null;

    let donationsData = [];
    let donationsCurrentPage = 1;
    let donationsSubscription = null;

    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user) {
      location.href = '/auth/login.html';
    }
    const memberId = user.id;

    async function getMemberIdNo() {
      const { data, error } = await supabase
        .from('members')
        .select('member_id_no')
        .eq('id', memberId)
        .single();

      if (error || !data) {
        console.error('Failed to get member_id_no:', error);
        return null;
      }
      return data.member_id_no;
    }

    async function loadProfile() {
      const { data: member, error } = await supabase
        .from('members')
        .select('*')
        .eq('id', memberId)
        .single();

      if (error || !member) {
        console.error('Profile error:', error);
        document.getElementById('member-name').textContent = 'Error loading profile';
        return;
      }

      currentMember = member;

      // Name display: full_name first
      const displayName = member.full_name?.trim() || member.nickname?.trim() || member.email_address?.split('@')[0] || 'Member';
      document.getElementById('member-name').textContent = displayName;

      document.getElementById('profile-photo').src = member.photo_url || '/assets/images/logo/logo1.png';
      document.getElementById('member-position').textContent = member.position || 'Alumnus';
      document.getElementById('location-badge').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${member.location || 'Not set'}`;
      document.getElementById('member-id').textContent = `Member ID: ${member.member_id_no || '—'}`;
      if (member.verified) document.getElementById('verified-badge').classList.remove('hidden');

      // Social links
      const showLink = (id, url, prefix = '') => {
        if (url?.trim()) {
          const fullUrl = url.startsWith('http') ? url : prefix + url;
          document.getElementById(id).href = fullUrl;
          document.getElementById(id).classList.remove('hidden');
        }
      };

      if (member.email_address) showLink('email-link', `mailto:${member.email_address}`);
      if (member.phone_number) {
        const clean = member.phone_number.replace(/\D/g, '');
        showLink('phone-link', `tel:${clean}`);
        showLink('whatsapp-link', `https://wa.me/${clean}`);
      }
      showLink('linkedin-link', member.linkedin);
      showLink('twitter-link', member.twitter);
      showLink('facebook-link', member.facebook);
      showLink('instagram-link', member.instagram);
      showLink('github-link', member.github);
      showLink('website-link', member.website);

      // Overview
      document.getElementById('bio-text').textContent = member.bio || 'No bio added yet.';
      const edu = document.getElementById('education-display');
      edu.innerHTML = member.education ? member.education.replace(/\n/g, '<br>') : '<p class="text-muted">No education details added.</p>';

      const interestsEl = document.getElementById('interests-display');
      if (member.interests) {
        const tags = member.interests.split(',').map(t => t.trim()).filter(t => t);
        interestsEl.innerHTML = tags.map(t => `<span class="px-4 py-2 bg-primary/10 text-primary rounded-full text-sm">${t}</span>`).join('');
      } else {
        interestsEl.innerHTML = '<p class="text-muted">No interests listed.</p>';
      }

      // Dashboard button
      if (['admin', 'super_admin', 'exco'].includes(member.role)) {
        document.getElementById('dashboard-btn').classList.remove('hidden');
      }
    }

    // Dues
    async function loadDuesHistory() {
      const memberIdNo = await getMemberIdNo();
      if (!memberIdNo) {
        document.getElementById('dues-body').innerHTML = '<tr><td colspan="5" class="text-center py-12 text-danger">Unable to load member info</td></tr>';
        return;
      }

      const { data, error } = await supabase
        .from('membership_dues')
        .select('dues_year, amount, category, sub_category, payment_date, status')
        .eq('member_id_no', memberIdNo)
        .order('dues_year', { ascending: false });

      if (error) {
        console.error('Dues error:', error);
        document.getElementById('dues-body').innerHTML = '<tr><td colspan="5" class="text-center py-12 text-danger">Error loading dues</td></tr>';
        return;
      }

      duesData = data || [];
      renderDuesPage(1);
    }

    function renderDuesPage(page) {
      duesCurrentPage = page;
      const start = (page - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageData = duesData.slice(start, end);

      const tbody = document.getElementById('dues-body');
      if (duesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-12 text-muted">No dues recorded yet.</td></tr>';
        document.getElementById('dues-pagination').classList.add('hidden');
        return;
      }

      tbody.innerHTML = pageData.map(d => `
        <tr class="hover:bg-primary/5 transition">
          <td class="py-5 text-gray-700">${d.dues_year || '-'}</td>
          <td class="py-5 text-gray-700 font-medium">₦${Number(d.amount || 0).toLocaleString()}</td>
          <td class="py-5 text-gray-700">${d.category || d.sub_category || '-'}</td>
          <td class="py-5 text-gray-700">${d.payment_date ? new Date(d.payment_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) : '-'}</td>
          <td class="py-5">
            <span class="px-4 py-1.5 rounded-full text-xs font-medium ${d.status === 'paid' ? 'bg-accent/20 text-accent' : d.status === 'pending' ? 'bg-primary/20 text-primary' : 'bg-danger/20 text-danger'}">
              ${d.status ? d.status.charAt(0).toUpperCase() + d.status.slice(1) : 'Unknown'}
            </span>
          </td>
        </tr>
      `).join('');

      const totalPages = Math.ceil(duesData.length / PAGE_SIZE);
      document.getElementById('dues-page-info').textContent = `Page ${page} of ${totalPages}`;
      document.getElementById('dues-prev').disabled = page === 1;
      document.getElementById('dues-next').disabled = end >= duesData.length;
      document.getElementById('dues-pagination').classList.toggle('hidden', totalPages <= 1);
    }

    function setupDuesRealtime() {
      if (duesSubscription) return;
      getMemberIdNo().then(memberIdNo => {
        if (!memberIdNo) return;
        duesSubscription = supabase.channel('dues_changes')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'membership_dues', filter: `member_id_no=eq.${memberIdNo}` }, payload => {
            duesData.unshift(payload.new);
            renderDuesPage(duesCurrentPage);
          })
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'membership_dues', filter: `member_id_no=eq.${memberIdNo}` }, payload => {
            const index = duesData.findIndex(item => item.id === payload.new.id);
            if (index !== -1) {
              duesData[index] = payload.new;
              renderDuesPage(duesCurrentPage);
            }
          })
          .subscribe();
      });
    }

    // Donations
    async function loadDonations() {
      const memberIdNo = await getMemberIdNo();
      if (!memberIdNo) {
        document.getElementById('donations-body').innerHTML = '<tr><td colspan="4" class="text-center py-12 text-danger">Unable to load member info</td></tr>';
        return;
      }

      const { data, error } = await supabase
        .from('donations')
        .select('created_at, payment_date, description, amount, status')
        .eq('member_id_no', memberIdNo)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Donations error:', error);
        document.getElementById('donations-body').innerHTML = '<tr><td colspan="4" class="text-center py-12 text-danger">Error loading donations</td></tr>';
        return;
      }

      donationsData = data || [];
      renderDonationsPage(1);
    }

    function renderDonationsPage(page) {
      donationsCurrentPage = page;
      const start = (page - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageData = donationsData.slice(start, end);

      const tbody = document.getElementById('donations-body');
      if (donationsData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-12 text-muted">No donations yet. Be the first to give back! ❤️</td></tr>';
        document.getElementById('donations-pagination').classList.add('hidden');
        return;
      }

      tbody.innerHTML = pageData.map(d => {
        const date = d.payment_date || d.created_at;
        return `
          <tr class="hover:bg-accent/5 transition">
            <td class="py-5 text-gray-700">${new Date(date).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</td>
            <td class="py-5 text-gray-700">${d.description || 'General Donation'}</td>
            <td class="py-5 text-gray-700 font-medium text-right">₦${Number(d.amount || 0).toLocaleString()}</td>
            <td class="py-5">
              <span class="px-4 py-1.5 rounded-full text-xs font-medium ${d.status === 'paid' || d.status === 'completed' ? 'bg-accent/20 text-accent' : d.status === 'pending' ? 'bg-primary/20 text-primary' : 'bg-danger/20 text-danger'}">
                ${d.status ? d.status.charAt(0).toUpperCase() + d.status.slice(1) : 'Pending'}
              </span>
            </td>
          </tr>
        `;
      }).join('');

      const totalPages = Math.ceil(donationsData.length / PAGE_SIZE);
      document.getElementById('donations-page-info').textContent = `Page ${page} of ${totalPages}`;
      document.getElementById('donations-prev').disabled = page === 1;
      document.getElementById('donations-next').disabled = end >= donationsData.length;
      document.getElementById('donations-pagination').classList.toggle('hidden', totalPages <= 1);
    }

    function setupDonationsRealtime() {
      if (donationsSubscription) return;
      getMemberIdNo().then(memberIdNo => {
        if (!memberIdNo) return;
        donationsSubscription = supabase.channel('donations_changes')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'donations', filter: `member_id_no=eq.${memberIdNo}` }, payload => {
            donationsData.unshift(payload.new);
            renderDonationsPage(donationsCurrentPage);
          })
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'donations', filter: `member_id_no=eq.${memberIdNo}` }, payload => {
            const index = donationsData.findIndex(item => item.id === payload.new.id);
            if (index !== -1) {
              donationsData[index] = payload.new;
              renderDonationsPage(donationsCurrentPage);
            }
          })
          .subscribe();
      });
    }

    // Edit Profile Modal Functions (unchanged from previous version)
    document.getElementById('edit-profile').addEventListener('click', () => {
      if (!currentMember) return;

      document.getElementById('input-fullname').value = currentMember.full_name || '';
      document.getElementById('input-nickname').value = currentMember.nickname || '';
      document.getElementById('input-position').value = currentMember.position || '';
      document.getElementById('input-phone').value = currentMember.phone_number || '';
      document.getElementById('input-email').value = currentMember.email_address || '';
      document.getElementById('input-location').value = currentMember.location || '';
      document.getElementById('input-twitter').value = currentMember.twitter || '';
      document.getElementById('input-facebook').value = currentMember.facebook || '';
      document.getElementById('input-instagram').value = currentMember.instagram || '';
      document.getElementById('input-github').value = currentMember.github || '';
      document.getElementById('input-linkedin').value = currentMember.linkedin || '';
      document.getElementById('input-website').value = currentMember.website || '';
      document.getElementById('input-bio').value = currentMember.bio || '';
      document.getElementById('input-education').value = currentMember.education || '';
      document.getElementById('input-interests').value = currentMember.interests || '';
      document.getElementById('preview-photo').src = currentMember.photo_url || '/assets/images/logo/logo1.png';

      document.getElementById('edit-modal').classList.remove('hidden');
    });

    document.getElementById('close-modal').addEventListener('click', () => document.getElementById('edit-modal').classList.add('hidden'));
    document.getElementById('cancel-edit').addEventListener('click', () => document.getElementById('edit-modal').classList.add('hidden'));

    document.getElementById('photo-input').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        currentPhotoFile = file;
        const reader = new FileReader();
        reader.onload = (ev) => document.getElementById('preview-photo').src = ev.target.result;
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const updates = {
        full_name: document.getElementById('input-fullname').value.trim(),
        nickname: document.getElementById('input-nickname').value.trim(),
        position: document.getElementById('input-position').value.trim(),
        phone_number: document.getElementById('input-phone').value.trim(),
        email_address: document.getElementById('input-email').value.trim(),
        location: document.getElementById('input-location').value.trim(),
        twitter: document.getElementById('input-twitter').value.trim(),
        facebook: document.getElementById('input-facebook').value.trim(),
        instagram: document.getElementById('input-instagram').value.trim(),
        github: document.getElementById('input-github').value.trim(),
        linkedin: document.getElementById('input-linkedin').value.trim(),
        website: document.getElementById('input-website').value.trim(),
        bio: document.getElementById('input-bio').value.trim(),
        education: document.getElementById('input-education').value.trim(),
        interests: document.getElementById('input-interests').value.trim(),
      };

      if (currentPhotoFile) {
        const fileExt = currentPhotoFile.name.split('.').pop();
        const fileName = `${memberId}.${fileExt}`;
        const { error: uploadError } = await supabase.storage
          .from('profile-photos')
          .upload(fileName, currentPhotoFile, { upsert: true });

        if (uploadError) {
          alert('Photo upload failed: ' + uploadError.message);
          return;
        }
        const { data: urlData } = supabase.storage.from('profile-photos').getPublicUrl(fileName);
        updates.photo_url = urlData.publicUrl;
      }

      const { error } = await supabase
        .from('members')
        .update(updates)
        .eq('id', memberId);

      if (error) {
        alert('Update failed: ' + error.message);
      } else {
        alert('Profile updated successfully!');
        document.getElementById('edit-modal').classList.add('hidden');
        currentPhotoFile = null;
        loadProfile();
      }
    });

    // Tab switching with loading
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-tab]').forEach(b => {
          b.classList.remove('tab-active');
          b.classList.add('text-muted');
        });
        btn.classList.add('tab-active');
        btn.classList.remove('text-muted');

        document.querySelectorAll('#tab-overview, #tab-dues, #tab-donations').forEach(t => t.classList.add('hidden'));
        document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');

        if (btn.dataset.tab === 'dues') {
          loadDuesHistory();
          setupDuesRealtime();
        }
        if (btn.dataset.tab === 'donations') {
          loadDonations();
          setupDonationsRealtime();
        }
      });
    });

    // Pagination
    document.getElementById('dues-prev')?.addEventListener('click', () => {
      if (duesCurrentPage > 1) renderDuesPage(duesCurrentPage - 1);
    });
    document.getElementById('dues-next')?.addEventListener('click', () => renderDuesPage(duesCurrentPage + 1));

    document.getElementById('donations-prev')?.addEventListener('click', () => {
      if (donationsCurrentPage > 1) renderDonationsPage(donationsCurrentPage - 1);
    });
    document.getElementById('donations-next')?.addEventListener('click', () => renderDonationsPage(donationsCurrentPage + 1));

    // Cleanup
    window.addEventListener('beforeunload', () => {
      supabase.removeAllChannels();
    });

    // Initial load
    loadProfile();
  </script>
  
<!-- FOOTER -->
<div id="footer"></div>

<!-- Scripts -->

<script src="/assets/js/theme.js"></script>
  <script src="/assets/js/loader.js"></script>
  <script src="/assets/js/page.js"></script>
  <script src="/components/navbar.js"></script>
</body>
</html>